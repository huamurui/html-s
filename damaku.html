<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>damaku</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
    }

    #playground {
      width: 80%;
      height: 80%;
      position: relative;
      background-color: aliceblue;
      overflow:  hidden;
    }

    .damaku {
      position: absolute;
      white-space: nowrap;
      /* è¿™ä¸ªå±æ€§è¿˜è›®å…³é”®çš„...å–µ */
      animation: damaku 10s linear; 
      font-size: 20;
      font-family: 'Arial'
    }

    .damaku:hover {
      animation-play-state: paused;
    }

    /* æ‚¬åœçš„å°æ°”æ³¡ */
    .damaku:hover::after {
      content: 'ğŸ¥°';
      position: absolute;
      /* æ€ä¹ˆå¯¹é½å•Š.. */      
      font-size: 20px;
      color: red;
    }

    @keyframes damaku {
      from {
        left: 100%;
      }
      to {
        left: -100%;
      }
    }
  </style>
</head>
<body>
  <div id="playground">
  </div>
  <script>
    /* 
      æˆ‘ä¼šæƒ³ç”¨ css åŠ¨ç”»è€Œä¸æ˜¯ canvas æ¥å®ç°å¼¹å¹•ã€‚
      å› ä¸ºæœ‰äº›ä¸œè¥¿åƒç»™å¼¹å¹•ç‚¹èµï¼Œæ‚¬æµ®æ—¶é™æ­¢ï¼Œè¿˜æ˜¯ç”¨å¸¸è§„çš„ dom æ“ä½œæ–¹ä¾¿å¾ˆå¤šã€‚

      æˆ‘æè¿‡ä¸€ä¸ªé£˜é›ªèŠ±çš„å° demoï¼Œé‚£ä¸ªæ˜¯ç”¨ canvas æ¥å®ç°çš„ï¼Œè™½ç„¶è¿™æ¬¡ä½¿ç”¨çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œä½†æœ‰äº›ä¸œè¥¿ä¾æ—§æ˜¯é€šçš„ã€‚ä¸€ä¸ªåœºæ™¯/è°ƒåº¦ä¸­å¿ƒï¼Œä¸€ä¸ªå…·ä½“åˆ›å»ºæ›´æ–°å¼¹å¹•çš„ã€‚åæ­£éƒ½æ˜¯é£˜å˜›...
    */
    function randomDataSource(){
      const data = [
        'ä½ å¥½',
        'æˆ‘æ˜¯',
        'å¤§å’ªå’ª',
        'wwwwwwwwwww',
        'å‘œå‘œå‘œ',
        'it seems everything is so difficult .. to me',
        'ã“ã® rainbow ã ',
        'äººçš„èƒ½åŠ›æ˜¯æœ‰æé™çš„ã€‚',
        'ãŠã‚Œã¯äººé—´ã‚’ã‚„ã‚ã‚‹ãï¼'
      ]

      const content  = data[Math.floor(Math.random() * data.length)]
      const style = {
        color:`rgb(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)})`,

      }
      return {
        content,
        style
      }
    }


    class Damaku {
      constructor(width, height, lineHeight, dataSource) {
        this.width = width
        this.height = height
        this.lineHeight = lineHeight
        this.channelNum = Math.floor(height / lineHeight)
        this.damakuList = new Array(this.channelNum).fill([]).map(() => [])

        this.dataSource = dataSource
        this.timer = null
      }

      /* åˆ›å»ºä¸€ä¸ªå¼¹å¹• */
      createDamaku(channel) {
        const data = {
          ...this.dataSource(),
          top: channel * this.lineHeight,
          left: this.width
        }
        const damaku = new DamakuItem(data)
        damaku.render()
        this.damakuList[channel].push(damaku)
      }
      /* æŸ¥çœ‹ä¸€ä¸‹å“ªä¸€è¡Œå¯ä»¥æ’ä¸€æ’ */
      checkChannel(channel) {
        console.log(this.damakuList)
        const damakuList = this.damakuList[channel]
        if (damakuList.length === 0) {
          return true
        }
        const lastDamaku = damakuList[damakuList.length - 1]
        const lastDamakuRect = lastDamaku.dom.getBoundingClientRect()
        return lastDamakuRect.left + lastDamakuRect.width < this.width
      }

      start(){
        this.timer = setInterval(() => {
          const channel = Math.floor(Math.random() * this.channelNum)
          if (this.checkChannel(channel)) {
            this.createDamaku(channel)
          }
          this.damakuList.forEach((damakuList, channel) => {
            damakuList.forEach((damaku, index) => {
              if (damaku.isDead()) {
                damaku.unRender()
                damakuList.splice(index, 1)
              }
            })
          })
        }, 1000)
      }

      stop() {
        clearInterval(this.timer)
      }
    }

    class DamakuItem {

      constructor(damaku) {

        this.dom = null

        this.content = damaku.content
        this.style = damaku.style
        this.top = damaku.top
        this.left = damaku.left      
      }

      render() {
        this.dom = document.createElement('div')
        this.dom.classList.add('damaku')
        this.dom.innerText = this.content
        this.dom.style = `
          top: ${this.top}px;
          left: ${this.left}px;
          color: ${this.style.color};
        `
        playground.appendChild(this.dom)
      }

      unRender() {
        playground.removeChild(this.dom)
      }
      isDead() {
        const { left } = this.dom.getBoundingClientRect()
        return left + this.dom.getBoundingClientRect().width < 0
      }
    }

    const playground = document.querySelector('#playground')
    const { width, height } = playground.getBoundingClientRect()

    let damaku = new Damaku(width, height, 30, randomDataSource)
    damaku.start()
  </script>
</body>
</html>